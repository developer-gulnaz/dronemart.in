<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DroneMart Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="assets/css/style.css" />

</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h4>DroneMart Admin</h4>
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="bi bi-arrow-left-circle"></i>
            </button>
        </div>
        <ul class="sidebar-menu">
            <li>
                <a href="dashboard.html" class="active">
                    <i class="fa-solid fa-gauge"></i>
                    <span class="menu-text">Dashboard</span>
                </a>
            </li>

            <li>
                <a href="users.html">
                    <i class="fa-solid fa-user-group"></i>
                    <span class="menu-text">Users</span>
                </a>
            </li>

            <li>
                <a href="leads.html">
                    <i class="fa-solid fa-address-card"></i>
                    <span class="menu-text">Leads</span>
                </a>
            </li>

            <li>
                <a href="repairs.html">
                    <i class="fa-solid fa-screwdriver-wrench"></i>
                    <span class="menu-text">Repair Requests</span>
                </a>
            </li>

            <li>
                <a href="products.html">
                    <i class="fa-solid fa-box-open"></i>
                    <span class="menu-text">Products</span>
                </a>
            </li>

            <li>
                <a href="accessories.html">
                    <i class="fa-solid fa-puzzle-piece"></i>
                    <span class="menu-text">Accessories</span>
                </a>
            </li>

            <li>
                <a href="orders.html">
                    <i class="fa-solid fa-receipt"></i>
                    <span class="menu-text">Orders</span>
                </a>
            </li>

            <li>
                <a href="#">
                    <i class="fa-solid fa-chart-line"></i>
                    <span class="menu-text">Analytics</span>
                </a>
            </li>

            <li>
                <a href="#">
                    <i class="fa-solid fa-gear"></i>
                    <span class="menu-text">Settings</span>
                </a>
            </li>
        </ul>
    </div>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Topbar / Header -->
        <div class="topbar">
            <button class="hamburger" id="hamburger">
                <i class="bi bi-list"></i>
            </button>
            <h4 class="mb-0">Update Accessory</h4>
            <div class="profile p-3" id="profileToggle">
                <div class="d-flex align-items-center">
                    <img src="https://ui-avatars.com/api/?name=User&background=random" alt="Profile"
                        class="rounded-circle me-2" width="40" height="40">
                    <div class="d-none d-md-block">
                        <div class="fw-bold" id="adminName">User</div>
                        <small class="text-muted" id="userType">Guest</small>
                    </div>
                </div>
            </div>

            <!-- Profile Dropdown -->
            <div class="profile-dropdown" id="profileDropdown">
                <div class="dropdown-item">
                    <i class="bi bi-person"></i> Profile
                </div>
                <div class="dropdown-item">
                    <i class="bi bi-gear"></i> Settings
                </div>
                <div class="dropdown-item">
                    <i class="bi bi-bell"></i> Notifications
                </div>
                <hr>
                <div class="dropdown-item" id="logoutBtn">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </div>
            </div>
        </div>
        <div class="container my-4">
            <form id="accessoryForm" enctype="multipart/form-data">
                <div class="row g-3">

                    <!-- Title -->
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="title" name="title" placeholder="Accessory Name"
                                required>
                            <label for="title">Accessory Name</label>
                        </div>
                    </div>

                    <!-- Slug -->
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="slug" name="slug"
                                placeholder="Slug (SEO-friendly URL)" readonly>
                            <label for="slug">Slug</label>
                        </div>
                    </div>

                    <!-- Type -->
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="type" name="type" placeholder="Type" required>
                            <label for="type">Type</label>
                        </div>
                    </div>

                    <!-- Brand -->
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="brand" name="brand" placeholder="Brand">
                            <label for="brand">Brand</label>
                        </div>
                    </div>

                    <!-- Category -->
                    <div class="col-md-6">
                        <div class="form-floating">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="category" name="category"
                                    placeholder="Category">
                                <label for="category">Category</label>
                            </div>
                        </div>
                    </div>

                    <!-- Product Category -->
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="productCategory" name="productCategory"
                                placeholder="Product Category">
                            <label for="productCategory">Product Category</label>
                        </div>
                    </div>

                    <!-- Price -->
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="number" class="form-control" id="price" name="price" placeholder="Price"
                                value="0" required>
                            <label for="price">Price</label>
                        </div>
                    </div>

                    <!-- Sale Price -->
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="number" class="form-control" id="salePrice" name="salePrice"
                                placeholder="Sale Price" value="0">
                            <label for="salePrice">Sale Price</label>
                        </div>
                    </div>

                    <!-- Stock -->
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="number" class="form-control" id="stock" name="stock" placeholder="Stock"
                                value="0">
                            <label for="stock">Stock</label>
                        </div>
                    </div>

                    <!-- In Stock Checkbox -->
                    <div class="col-md-6 d-flex align-items-center mt-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="true" id="inStock" name="inStock"
                                checked>
                            <label class="form-check-label" for="inStock">
                                In Stock
                            </label>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="col-12">
                        <div class="form-floating">
                            <textarea class="form-control" id="description" name="description" placeholder="Description"
                                style="height:120px"></textarea>
                            <label for="description">Description</label>
                        </div>
                    </div>

                    <!-- Short Description -->
                    <div class="col-12">
                        <div class="form-floating">
                            <textarea class="form-control" id="shortDescription" name="shortDescription"
                                placeholder="Short Description" style="height:80px"></textarea>
                            <label for="shortDescription">Short Description</label>
                        </div>
                    </div>

                    <!-- Specs (JSON) -->
                    <div class="col-12">
                        <div class="form-floating">
                            <textarea class="form-control" id="specs" name="specs"
                                placeholder='{"Weight":"1kg","Color":"Black"}' style="height:100px"></textarea>
                            <label for="specs">Specs (JSON format)</label>
                        </div>
                    </div>

                    <!-- Main Image -->
                    <div class="col-md-6">
                        <label for="mainImage" class="form-label">Main Image</label>
                        <input type="file" class="form-control" id="image" name="image" accept="image/*">
                    </div>

                    <!-- Thumbnails -->
                    <div class="col-md-6">
                        <label for="thumbnails" class="form-label">Thumbnail Images</label>
                        <input type="file" class="form-control" id="thumbnails" name="thumbnails" accept="image/*"
                            multiple>
                        <div id="thumbPreview" class="mt-2 d-flex flex-wrap gap-2"></div>
                    </div>

                    <!-- In the Box -->
                    <div class="col-12">
                        <label class="form-label">In The Box Items</label>
                        <div id="inTheBoxContainer">
                            <div class="row g-2 mb-2 in-box-item">
                                <div class="col-md-4">
                                    <input type="text" class="form-control" name="inTheBoxTitle[]"
                                        placeholder="Item Title">
                                </div>
                                <div class="col-md-3">
                                    <input type="number" class="form-control" name="inTheBoxQuantity[]"
                                        placeholder="Quantity" value="1">
                                </div>
                                <div class="col-md-5">
                                    <input type="file" class="form-control" name="inTheBoxImage[]" accept="image/*">
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary mt-2" id="addBoxItem">Add Item</button>
                    </div>

                    <!-- Meta Title -->
                    <div class="col-12">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="metaTitle" name="metaTitle"
                                placeholder="Meta Title">
                            <label for="metaTitle">Meta Title</label>
                        </div>
                    </div>

                    <!-- Meta Description -->
                    <div class="col-12">
                        <div class="form-floating">
                            <textarea class="form-control" id="metaDescription" name="metaDescription"
                                placeholder="Meta Description" style="height:80px"></textarea>
                            <label for="metaDescription">Meta Description</label>
                        </div>
                    </div>

                    <!-- Keywords -->
                    <div class="col-12">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="keywords" name="keywords"
                                placeholder="Keywords (comma-separated)">
                            <label for="keywords">Keywords</label>
                        </div>
                    </div>

                    <!-- Submit -->
                    <div class="col-12 mt-3">
                        <button type="submit" class="btn btn-primary w-100">Save Accessory</button>
                    </div>

                </div>
            </form>

        </div>

        <!-- Users Table -->

    </div>
    <script src="assets/js/common.js"></script>
    <script src="assets/js/main.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const form = document.getElementById("accessoryForm");
            const params = new URLSearchParams(window.location.search);
            const accessoryId = params.get("id");

            if (!accessoryId) {
                alert("No Accessory ID found in URL!");
                return;
            }

            // ================= Fetch existing accessory =================
            const res = await fetch(`/api/accessory/${accessoryId}`);
            const accessory = await res.json();

            if (!res.ok) {
                alert("Failed to load accessory");
                return;
            }

            // ================= Fill form fields =================
            document.getElementById("title").value = accessory.title;
            document.getElementById("slug").value = accessory.slug;
            document.getElementById("type").value = accessory.type || "";
            document.getElementById("brand").value = accessory.brand || "";
            document.getElementById("category").value = accessory.category || "";
            document.getElementById("productCategory").value = accessory.productCategory || "";
            document.getElementById("price").value = accessory.price || 0;
            document.getElementById("salePrice").value = accessory.salePrice || 0;
            document.getElementById("stock").value = accessory.stock || 0;
            document.getElementById("inStock").checked = accessory.inStock;
            document.getElementById("description").value = accessory.description || "";
            document.getElementById("shortDescription").value = accessory.shortDescription || "";
            document.getElementById("specs").value = JSON.stringify(accessory.specs || {}, null, 2);
            document.getElementById("metaTitle").value = accessory.metaTitle || "";
            document.getElementById("metaDescription").value = accessory.metaDescription || "";
            document.getElementById("keywords").value = accessory.keywords?.join(", ") || "";

            // ================= Preview main image =================
            const imageContainer = document.getElementById("image").parentNode;
            if (accessory.image) {
                const img = document.createElement("img");
                img.src = "" + accessory.image;
                img.style.width = "100px";
                img.classList.add("mt-2", "border", "rounded");
                img.id = "existingMainImage";
                imageContainer.appendChild(img);
            }

            // ================= Preview thumbnails =================
            const thumbPreview = document.getElementById("thumbPreview");
            if (accessory.thumbnails && accessory.thumbnails.length) {
                accessory.thumbnails.forEach((t, i) => {
                    const img = document.createElement("img");
                    img.src = "" + t;
                    img.style.width = "80px";
                    img.style.height = "80px";
                    img.style.objectFit = "cover";
                    img.classList.add("border", "rounded");
                    img.dataset.index = i;
                    thumbPreview.appendChild(img);
                });
            }

            // ================= Fill In-The-Box =================
            const container = document.getElementById("inTheBoxContainer");
            container.innerHTML = "";
            if (accessory.inTheBox && accessory.inTheBox.length) {
                accessory.inTheBox.forEach((item, i) => {
                    const div = document.createElement("div");
                    div.classList.add("row", "g-2", "mb-2", "in-box-item");
                    div.innerHTML = `
                <div class="col-md-4">
                    <input type="text" class="form-control" name="inTheBoxTitle[]" value="${item.title}" required>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control" name="inTheBoxQuantity[]" value="${item.quantity}" min="1" required>
                </div>
                <div class="col-md-5">
                    <input type="file" class="form-control" name="inTheBoxImage[]" accept="image/*">
                    ${item.image ? `<img src="/${item.image}" style="width:80px" class="mt-1 border rounded">` : ""}
                </div>
            `;
                    container.appendChild(div);
                });
            }

            // ================= Add new In-The-Box item =================
            document.getElementById('addBoxItem').addEventListener('click', () => {
                const item = document.createElement('div');
                item.classList.add('row', 'g-2', 'mb-2', 'in-box-item');
                item.innerHTML = `
            <div class="col-md-4">
                <input type="text" class="form-control" name="inTheBoxTitle[]" placeholder="Item Title" required>
            </div>
            <div class="col-md-3">
                <input type="number" class="form-control" name="inTheBoxQuantity[]" placeholder="Quantity" value="1" min="1" required>
            </div>
            <div class="col-md-5">
                <input type="file" class="form-control" name="inTheBoxImage[]" accept="image/*">
            </div>
        `;
                container.appendChild(item);
            });

            // ================= Form Submission =================
            form.addEventListener("submit", async e => {
                e.preventDefault();
                const formData = new FormData(form);

                // Append In-The-Box items
                const titles = document.getElementsByName("inTheBoxTitle[]");
                const qtys = document.getElementsByName("inTheBoxQuantity[]");
                const images = document.getElementsByName("inTheBoxImage[]");

                for (let i = 0; i < titles.length; i++) {
                    formData.append("inTheBox[]", JSON.stringify({
                        title: titles[i].value,
                        quantity: qtys[i].value,
                    }));
                    if (images[i].files[0]) {
                        formData.append("inTheBoxImages[]", images[i].files[0]);
                    }
                }

                try {
                    const res = await fetch(`/api/accessory/${accessoryId}`, {
                        method: "PUT",
                        body: formData,
                    });

                    const data = await res.json();
                    if (res.ok) {
                        alert("Accessory updated successfully!");
                        window.location.href = "/admin/accessories.html";
                    } else {
                        alert("Error: " + data.message);
                    }
                } catch (err) {
                    console.error(err);
                    alert("Something went wrong.");
                }
            });
        });
    </script>


</body>

</html>