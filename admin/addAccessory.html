<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DroneMart Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="assets/css/style.css" />

</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h4>DroneMart Admin</h4>
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="bi bi-arrow-left-circle"></i>
            </button>
        </div>
        <ul class="sidebar-menu">
            <li>
                <a href="dashboard.html" class="active">
                    <i class="fa-solid fa-gauge"></i>
                    <span class="menu-text">Dashboard</span>
                </a>
            </li>

            <li>
                <a href="users.html">
                    <i class="fa-solid fa-user-group"></i>
                    <span class="menu-text">Users</span>
                </a>
            </li>

            <li>
                <a href="leads.html">
                    <i class="fa-solid fa-address-card"></i>
                    <span class="menu-text">Leads</span>
                </a>
            </li>

            <li>
                <a href="repairs.html">
                    <i class="fa-solid fa-screwdriver-wrench"></i>
                    <span class="menu-text">Repair Requests</span>
                </a>
            </li>

            <li>
                <a href="products.html">
                    <i class="fa-solid fa-box-open"></i>
                    <span class="menu-text">Products</span>
                </a>
            </li>

            <li>
                <a href="accessories.html">
                    <i class="fa-solid fa-puzzle-piece"></i>
                    <span class="menu-text">Accessories</span>
                </a>
            </li>

            <li>
                <a href="orders.html">
                    <i class="fa-solid fa-receipt"></i>
                    <span class="menu-text">Orders</span>
                </a>
            </li>

            <li>
                <a href="#">
                    <i class="fa-solid fa-chart-line"></i>
                    <span class="menu-text">Analytics</span>
                </a>
            </li>

            <li>
                <a href="#">
                    <i class="fa-solid fa-gear"></i>
                    <span class="menu-text">Settings</span>
                </a>
            </li>
        </ul>
    </div>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Topbar / Header -->
        <div class="topbar">
            <button class="hamburger" id="hamburger">
                <i class="bi bi-list"></i>
            </button>
            <h4 class="mb-0">Add Accessory</h4>
            <div class="profile p-3" id="profileToggle">
                <div class="d-flex align-items-center">
                    <img src="https://ui-avatars.com/api/?name=User&background=random" alt="Profile"
                        class="rounded-circle me-2" width="40" height="40">
                    <div class="d-none d-md-block">
                        <div class="fw-bold" id="adminName">User</div>
                        <small class="text-muted" id="userType">Guest</small>
                    </div>
                </div>
            </div>

            <!-- Profile Dropdown -->
            <div class="profile-dropdown" id="profileDropdown">
                <div class="dropdown-item">
                    <i class="bi bi-person"></i> Profile
                </div>
                <div class="dropdown-item">
                    <i class="bi bi-gear"></i> Settings
                </div>
                <div class="dropdown-item">
                    <i class="bi bi-bell"></i> Notifications
                </div>
                <hr>
                <div class="dropdown-item" id="logoutBtn">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </div>
            </div>
        </div>
        <div class="container my-4">
            <form id="accessoryForm" enctype="multipart/form-data">
                <div class="row g-3">

                    <!-- Title -->
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="title" name="title" placeholder="Accessory Name"
                                required>
                            <label for="title">Accessory Name</label>
                        </div>
                    </div>

                    <!-- Slug -->
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="slug" name="slug"
                                placeholder="Slug (SEO-friendly URL)" readonly>
                            <label for="slug">Slug</label>
                        </div>
                    </div>

                    <!-- Type -->
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="type" name="type" placeholder="Type" required>
                            <label for="type">Type</label>
                        </div>
                    </div>

                    <!-- Brand -->
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="brand" name="brand" placeholder="Brand">
                            <label for="brand">Brand</label>
                        </div>
                    </div>

                    <!-- Category -->
                    <div class="col-md-6">
                        <div class="form-floating">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="category" name="category"
                                    placeholder="Category">
                                <label for="category">Category</label>
                            </div>
                        </div>
                    </div>

                    <!-- Product Category -->
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="productCategory" name="productCategory"
                                placeholder="Product Category">
                            <label for="productCategory">Product Category</label>
                        </div>
                    </div>

                    <!-- Price -->
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="number" class="form-control" id="price" name="price" placeholder="Price"
                                value="0" required>
                            <label for="price">Price</label>
                        </div>
                    </div>

                    <!-- Sale Price -->
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="number" class="form-control" id="salePrice" name="salePrice"
                                placeholder="Sale Price" value="0">
                            <label for="salePrice">Sale Price</label>
                        </div>
                    </div>

                    <!-- Stock -->
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="number" class="form-control" id="stock" name="stock" placeholder="Stock"
                                value="0">
                            <label for="stock">Stock</label>
                        </div>
                    </div>

                    <!-- In Stock Checkbox -->
                    <div class="col-md-6 d-flex align-items-center mt-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="true" id="inStock" name="inStock"
                                checked>
                            <label class="form-check-label" for="inStock">
                                In Stock
                            </label>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="col-12">
                        <div class="form-floating">
                            <textarea class="form-control" id="description" name="description" placeholder="Description"
                                style="height:120px"></textarea>
                            <label for="description">Description</label>
                        </div>
                    </div>

                    <!-- Short Description -->
                    <div class="col-12">
                        <div class="form-floating">
                            <textarea class="form-control" id="shortDescription" name="shortDescription"
                                placeholder="Short Description" style="height:80px"></textarea>
                            <label for="shortDescription">Short Description</label>
                        </div>
                    </div>

                    <!-- Specs (JSON) -->
                    <div class="col-12">
                        <div class="form-floating">
                            <textarea class="form-control" id="specs" name="specs"
                                placeholder='{"Weight":"1kg","Color":"Black"}' style="height:100px"></textarea>
                            <label for="specs">Specs (JSON format)</label>
                        </div>
                    </div>

                    <!-- Main Image -->
                    <div class="col-md-6">
                        <label for="mainImage" class="form-label">Main Image</label>
                        <input type="file" class="form-control" id="image" name="image" accept="image/*" required>
                        <div id="mainPreview" class="mt-2 d-flex gap-2"></div>
                    </div>

                    <!-- Thumbnails -->
                    <div class="col-md-6">
                        <label for="thumbnails" class="form-label">Thumbnail Images</label>
                        <input type="file" class="form-control" id="thumbnails" name="thumbnails" accept="image/*"
                            multiple>
                        <div id="thumbPreview" class="mt-2 d-flex flex-wrap gap-2"></div>
                    </div>

                    <!-- In-The-Box -->
                    <div class="col-12">
                        <label class="form-label">In The Box Items</label>
                        <div id="inTheBoxContainer">
                            <div class="row g-2 mb-2 in-box-item">
                                <div class="col-md-4">
                                    <input type="text" class="form-control" name="inTheBoxTitle[]"
                                        placeholder="Item Title">
                                </div>
                                <div class="col-md-3">
                                    <input type="number" class="form-control" name="inTheBoxQuantity[]"
                                        placeholder="Quantity" value="1">
                                </div>
                                <div class="col-md-5">
                                    <input type="file" class="form-control inBoxImage" name="inTheBoxImage[]"
                                        accept="image/*">
                                    <div class="inBoxPreview mt-1 d-flex gap-2"></div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary mt-2" id="addBoxItem">Add Item</button>
                    </div>


                    <!-- Meta Title -->
                    <div class="col-12">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="metaTitle" name="metaTitle"
                                placeholder="Meta Title">
                            <label for="metaTitle">Meta Title</label>
                        </div>
                    </div>

                    <!-- Meta Description -->
                    <div class="col-12">
                        <div class="form-floating">
                            <textarea class="form-control" id="metaDescription" name="metaDescription"
                                placeholder="Meta Description" style="height:80px"></textarea>
                            <label for="metaDescription">Meta Description</label>
                        </div>
                    </div>

                    <!-- Keywords -->
                    <div class="col-12">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="keywords" name="keywords"
                                placeholder="Keywords (comma-separated)">
                            <label for="keywords">Keywords</label>
                        </div>
                    </div>

                    <!-- Submit -->
                    <div class="col-12 mt-3">
                        <button type="submit" class="btn btn-primary w-100">Save Accessory</button>
                    </div>

                </div>
            </form>

        </div>

        <!-- Users Table -->

    </div>
    <script src="assets/js/common.js"></script>
    <script src="assets/js/main.js"></script>


    <script>
        // ---------------------------
        // Auto-generate slug
        // ---------------------------
        const titleInput = document.getElementById('title');
        const slugInput = document.getElementById('slug');
        titleInput.addEventListener('input', () => {
            const slug = titleInput.value
                .toLowerCase()
                .trim()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-');
            slugInput.value = slug;
        });

        // ---------------------------
        // Helper to create preview image with remove button
        // ---------------------------
        function createPreviewImage(file, width = 80, height = 80, container, callback) {
            const reader = new FileReader();
            reader.onload = e => {
                const wrapper = document.createElement('div');
                wrapper.classList.add('position-relative');
                wrapper.style.display = 'inline-block';

                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.width = width + 'px';
                img.style.height = height + 'px';
                img.style.objectFit = 'cover';
                img.classList.add('border', 'rounded');

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.innerHTML = '&times;';
                removeBtn.style.position = 'absolute';
                removeBtn.style.top = '-5px';
                removeBtn.style.right = '-5px';
                removeBtn.classList.add('btn', 'btn-sm', 'btn-danger');
                removeBtn.addEventListener('click', () => {
                    wrapper.remove();
                    if (callback) callback();
                });

                wrapper.appendChild(img);
                wrapper.appendChild(removeBtn);
                container.appendChild(wrapper);

                return wrapper;
            };
            reader.readAsDataURL(file);
        }

        // ---------------------------
        // Main Image Preview
        // ---------------------------
        const mainInput = document.getElementById('image');
        const mainPreview = document.getElementById('mainPreview');

        mainInput.addEventListener('change', function () {
            mainPreview.innerHTML = '';
            if (this.files && this.files[0]) {
                createPreviewImage(this.files[0], 120, 120, mainPreview, () => mainInput.value = '');
            }
        });

        // ---------------------------
        // Thumbnails Preview with drag-drop and remove
        // ---------------------------
        const thumbInput = document.getElementById('thumbnails');
        const thumbPreview = document.getElementById('thumbPreview');
        let thumbFiles = [];

        function renderThumbs() {
            thumbPreview.innerHTML = '';
            thumbPreview.style.display = 'flex';
            thumbPreview.style.flexWrap = 'wrap';
            thumbPreview.style.gap = '10px'; // spacing between thumbnails

            thumbFiles.forEach((file, index) => {
                const wrapper = document.createElement('div');
                wrapper.classList.add('position-relative');
                wrapper.style.width = '80px';
                wrapper.style.height = '80px';
                wrapper.style.flex = '0 0 auto'; // fix width in flex container
                wrapper.dataset.index = index;
                wrapper.style.cursor = 'grab';

                const reader = new FileReader();
                reader.onload = e => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    img.classList.add('border', 'rounded');

                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.innerHTML = '&times;';
                    removeBtn.style.position = 'absolute';
                    removeBtn.style.top = '-5px';
                    removeBtn.style.right = '-5px';
                    removeBtn.classList.add('btn', 'btn-sm', 'btn-danger');
                    removeBtn.addEventListener('click', () => {
                        thumbFiles.splice(index, 1);
                        renderThumbs();
                    });

                    wrapper.appendChild(img);
                    wrapper.appendChild(removeBtn);
                };
                reader.readAsDataURL(file);

                // Drag & Drop
                wrapper.draggable = true;
                wrapper.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', index));
                wrapper.addEventListener('dragover', e => e.preventDefault());
                wrapper.addEventListener('drop', e => {
                    e.preventDefault();
                    const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    const toIndex = parseInt(wrapper.dataset.index);
                    const temp = thumbFiles[fromIndex];
                    thumbFiles.splice(fromIndex, 1);
                    thumbFiles.splice(toIndex, 0, temp);
                    renderThumbs();
                });

                thumbPreview.appendChild(wrapper);
            });
        }

        thumbInput.addEventListener('change', function () {
            thumbFiles = Array.from(this.files);
            renderThumbs();
        });

        // ---------------------------
        // Add In-The-Box Item dynamically
        // ---------------------------
        document.getElementById('addBoxItem').addEventListener('click', () => {
            const container = document.getElementById('inTheBoxContainer');
            const item = document.createElement('div');
            item.classList.add('row', 'g-2', 'mb-2', 'in-box-item');

            item.innerHTML = `
            <div class="col-md-4">
                <input type="text" class="form-control" name="inTheBoxTitle[]" placeholder="Item Title" required>
            </div>
            <div class="col-md-3">
                <input type="number" class="form-control" name="inTheBoxQuantity[]" placeholder="Quantity" value="1" min="1" required>
            </div>
            <div class="col-md-5">
                <input type="file" class="form-control inBoxImage" name="inTheBoxImage[]" accept="image/*">
                <div class="inBoxPreview mt-1 d-flex gap-2"></div>
            </div>
        `;

            container.appendChild(item);

            const fileInput = item.querySelector('.inBoxImage');
            const previewDiv = item.querySelector('.inBoxPreview');
            fileInput.addEventListener('change', function () {
                previewDiv.innerHTML = '';
                if (this.files && this.files[0]) {
                    createPreviewImage(this.files[0], 80, 80, previewDiv, () => fileInput.value = '');
                }
            });
        });

        // ---------------------------
        // Attach preview to existing in-box images
        // ---------------------------
        document.querySelectorAll('.inBoxImage').forEach(input => {
            const previewDiv = input.nextElementSibling;
            input.addEventListener('change', function () {
                previewDiv.innerHTML = '';
                if (this.files && this.files[0]) {
                    createPreviewImage(this.files[0], 80, 80, previewDiv, () => input.value = '');
                }
            });
        });

        // ---------------------------
        // Form submission
        // ---------------------------
        document.getElementById('accessoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = document.getElementById('accessoryForm');
            const formData = new FormData(form);

            // Replace thumbnails with selected files in correct sequence
            thumbFiles.forEach(file => formData.append('thumbnails[]', file));

            // Specs
            const specsText = form.querySelector('[name="specs"]').value;
            formData.set("specs", specsText);

            // In-the-box items
            const inBoxTitles = document.getElementsByName('inTheBoxTitle[]');
            const inBoxQty = document.getElementsByName('inTheBoxQuantity[]');
            const inBoxImages = document.getElementsByName('inTheBoxImage[]');

            for (let i = 0; i < inBoxTitles.length; i++) {
                formData.append('inTheBox[]', JSON.stringify({
                    title: inBoxTitles[i].value,
                    quantity: inBoxQty[i].value
                }));
                if (inBoxImages[i].files[0]) {
                    formData.append('inTheBoxImage[]', inBoxImages[i].files[0]);
                }
            }

            if (mainInput.files[0]) {
                formData.append('image', mainInput.files[0]);
            }

            try {
                const res = await fetch('/api/accessory', {
                    method: 'POST',
                    body: formData
                });

                if (res.ok) {
                    alert('Accessory added successfully!');
                    form.reset();
                    mainPreview.innerHTML = '';
                    thumbPreview.innerHTML = '';
                    document.getElementById('inTheBoxContainer').innerHTML = '';
                    thumbFiles = [];
                } else {
                    const err = await res.json();
                    alert('Error: ' + err.message);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });
    </script>



</body>

</html>