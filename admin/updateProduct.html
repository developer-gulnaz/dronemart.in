<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DroneMart Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="assets/css/style.css" />

</head>

<body>


    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h4>DroneMart Admin</h4>
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="bi bi-arrow-left-circle"></i>
            </button>
        </div>
        <ul class="sidebar-menu">
            <li>
                <a href="dashboard.html" class="active">
                    <i class="fa-solid fa-gauge"></i>
                    <span class="menu-text">Dashboard</span>
                </a>
            </li>

            <li>
                <a href="users.html">
                    <i class="fa-solid fa-user-group"></i>
                    <span class="menu-text">Users</span>
                </a>
            </li>

            <li>
                <a href="leads.html">
                    <i class="fa-solid fa-address-card"></i>
                    <span class="menu-text">Leads</span>
                </a>
            </li>

            <li>
                <a href="repairs.html">
                    <i class="fa-solid fa-screwdriver-wrench"></i>
                    <span class="menu-text">Repair Requests</span>
                </a>
            </li>

           <li>
        <a href="customerInquiries.html">
          <i class="fa-solid fa-users-gear"></i>
          <span class="menu-text">Customer Inquiries</span>
        </a>
      </li>

      <li>
        <a href="products.html">
          <i class="fa-solid fa-box-open"></i>
          <span class="menu-text">Products</span>
        </a>
      </li>

      <li>
        <a href="accessories.html">
          <i class="fa-solid fa-toolbox"></i>
          <span class="menu-text">Accessories</span>
        </a>
      </li>

            <li>
                <a href="orders.html">
                    <i class="fa-solid fa-receipt"></i>
                    <span class="menu-text">Orders</span>
                </a>
            </li>

            <li>
                <a href="#">
                    <i class="fa-solid fa-chart-line"></i>
                    <span class="menu-text">Analytics</span>
                </a>
            </li>

            <li>
                <a href="#">
                    <i class="fa-solid fa-gear"></i>
                    <span class="menu-text">Settings</span>
                </a>
            </li>
        </ul>
    </div>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Topbar / Header -->
        <div class="topbar">
            <button class="hamburger" id="hamburger">
                <i class="bi bi-list"></i>
            </button>
            <h4 class="mb-0">Update Product</h4>
            <div class="profile p-3" id="profileToggle">
                <div class="d-flex align-items-center">
                    <img src="https://ui-avatars.com/api/?name=User&background=random" alt="Profile"
                        class="rounded-circle me-2" width="40" height="40">
                    <div class="d-none d-md-block">
                        <div class="fw-bold" id="adminName">User</div>
                        <small class="text-muted" id="userType">Guest</small>
                    </div>
                </div>
            </div>

            <!-- Profile Dropdown -->
            <div class="profile-dropdown" id="profileDropdown">
                <div class="dropdown-item">
                    <i class="bi bi-person"></i> Profile
                </div>
                <div class="dropdown-item">
                    <i class="bi bi-gear"></i> Settings
                </div>
                <div class="dropdown-item">
                    <i class="bi bi-bell"></i> Notifications
                </div>
                <hr>
                <div class="dropdown-item" id="logoutBtn">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </div>
            </div>
        </div>

        <div class="container my-4">
            <form id="productForm" enctype="multipart/form-data">

            </form>
        </div>



        <!-- Users Table -->

    </div>
    <script src="assets/js/common.js"></script>
    <script src="assets/js/main.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const productId = new URLSearchParams(window.location.search).get("id");
            if (!productId) {
                alert("No product ID provided");
                return;
            }

            const form = document.getElementById("productForm");
            if (!form) {
                console.error("Form not found");
                return;
            }

            // ✅ Fetch product
            async function loadProductData() {
                try {
                    const res = await fetch(`/api/products/${productId}`, { credentials: "include" });
                    if (!res.ok) throw new Error("Failed to fetch product data");
                    const product = await res.json();

                    form.innerHTML = "";
                    generateFieldsFromObject(product, form);
                    addSubmitButton();

                    // ============================
                    // Handle existing images
                    // ============================

                    // Main Image
                    const mainImgField = form.querySelector('input[name="image"]');
                    if (product.image && mainImgField) {
                        const preview = document.createElement("div");
                        preview.className = "image-preview";
                        preview.innerHTML = `<img src="${product.image}" style="max-width:150px">`;
                        mainImgField.parentNode.insertBefore(preview, mainImgField.nextSibling);

                        // hidden input to preserve existing image
                        const hidden = document.createElement("input");
                        hidden.type = "hidden";
                        hidden.name = "image_existing";
                        hidden.value = product.image;
                        mainImgField.parentNode.insertBefore(hidden, preview.nextSibling);
                    }

                    // Thumbnails
                    // ============================
                    // ✅ Thumbnails Handling (simple + synced with preview)
                    // ============================
                    const thumbInput = form.querySelector('input[name="thumbnails"]');
                    const thumbPreview = document.createElement("div");
                    thumbPreview.className = "thumbnail-preview";
                    thumbPreview.style.display = "flex";
                    thumbPreview.style.flexWrap = "wrap";
                    thumbPreview.style.gap = "6px";
                    thumbInput.parentNode.insertBefore(thumbPreview, thumbInput.nextSibling);

                    // Keep track of current thumbnails (URLs or local files)
                    let currentThumbnails = [];

                    // 🔹 Load existing thumbnails
                    if (product.thumbnails && Array.isArray(product.thumbnails)) {
                        currentThumbnails = [...product.thumbnails];
                        renderThumbnails();
                    }

                    // 🔹 Render preview box
                    function renderThumbnails() {
                        thumbPreview.innerHTML = "";

                        currentThumbnails.forEach((thumb, i) => {
                            const wrapper = document.createElement("div");
                            wrapper.style.position = "relative";
                            wrapper.style.width = "100px";
                            wrapper.style.height = "100px";

                            const img = document.createElement("img");
                            img.src = typeof thumb === "string" ? thumb : URL.createObjectURL(thumb);
                            img.style.width = "100%";
                            img.style.height = "100%";
                            img.style.objectFit = "cover";
                            img.style.borderRadius = "6px";
                            img.style.border = "1px solid #ccc";
                            wrapper.appendChild(img);

                            // ❌ Remove Button
                            const delBtn = document.createElement("button");
                            delBtn.textContent = "×";
                            delBtn.type = "button";
                            delBtn.style.position = "absolute";
                            delBtn.style.top = "2px";
                            delBtn.style.right = "2px";
                            delBtn.style.background = "rgba(0,0,0,0.6)";
                            delBtn.style.color = "#fff";
                            delBtn.style.border = "none";
                            delBtn.style.borderRadius = "50%";
                            delBtn.style.width = "20px";
                            delBtn.style.height = "20px";
                            delBtn.style.cursor = "pointer";
                            delBtn.addEventListener("click", () => {
                                currentThumbnails.splice(i, 1);
                                renderThumbnails();
                            });

                            wrapper.appendChild(delBtn);
                            thumbPreview.appendChild(wrapper);
                        });
                    }

                    // 🔹 When new files are added
                    thumbInput.addEventListener("change", (e) => {
                        const newFiles = Array.from(e.target.files);
                        if (newFiles.length > 0) {
                            currentThumbnails.push(...newFiles);
                            renderThumbnails();
                        }
                    });

                    // 🔹 On form submit
                    form.addEventListener("submit", async (e) => {
                        e.preventDefault();
                        const formData = new FormData(form);

                        // Clear old thumbnail fields
                        formData.delete("thumbnails");
                        formData.delete("thumbnails_existing[]");

                        // Separate URLs and Files
                        currentThumbnails.forEach(item => {
                            if (typeof item === "string") {
                                formData.append("thumbnails_existing[]", item);
                            } else {
                                formData.append("thumbnails", item);
                            }
                        });

                        // Submit to backend
                        try {
                            const res = await fetch(`/api/products/${productId}`, {
                                method: "PATCH",
                                body: formData,
                                credentials: "include",
                            });

                            if (!res.ok) throw new Error("Failed to update product");
                            alert("✅ Product updated successfully!");
                            window.location.href = "products.html";
                        } catch (err) {
                            console.error(err);
                            alert("Error updating product");
                        }
                    });

                    // InTheBox images
                    const inTheBoxItems = form.querySelectorAll('.box-item input[name*="inTheBoxImage"]');
                    if (product.inTheBox && Array.isArray(product.inTheBox)) {
                        product.inTheBox.forEach((item, idx) => {
                            const boxDiv = inTheBoxItems[idx]?.parentNode;
                            if (boxDiv && item.image) {
                                const preview = document.createElement("div");
                                preview.className = "image-preview";
                                preview.innerHTML = `<img src="${item.image}" style="max-width:100px">`;
                                boxDiv.insertBefore(preview, boxDiv.querySelector('input[type="file"]'));

                                const hidden = document.createElement("input");
                                hidden.type = "hidden";
                                hidden.name = "inTheBoxImage_existing[]";
                                hidden.value = item.image;
                                boxDiv.appendChild(hidden);
                            }
                        });
                    }

                } catch (err) {
                    console.error(err);
                    alert("Error loading product data");
                }
            }

            // 🧩 Recursive Field Generator (2-column applied everywhere)
            function generateFieldsFromObject(obj, container, parentKey = "") {
                Object.entries(obj).forEach(([key, value]) => {
                    const fullKey = parentKey ? `${parentKey}.${key}` : key;

                    if (["_id", "__v", "createdAt", "updatedAt"].includes(key)) return;

                    // ========== OBJECTS ==========
                    if (typeof value === "object" && !Array.isArray(value) && value !== null) {
                        const block = document.createElement("div");
                        block.classList.add("section-block");

                        const title = document.createElement("h6");
                        title.textContent = key.replace(/([A-Z])/g, " $1").toUpperCase();
                        block.appendChild(title);

                        const innerGrid = document.createElement("div");
                        innerGrid.classList.add("nested-grid");
                        generateFieldsFromObject(value, innerGrid, fullKey);

                        block.appendChild(innerGrid);
                        container.appendChild(block);
                    }

                    // ========== ARRAYS ==========
                    else if (Array.isArray(value)) {
                        const block = document.createElement("div");
                        block.classList.add("section-block");

                        const title = document.createElement("h6");
                        title.textContent = key.replace(/([A-Z])/g, " $1").toUpperCase();
                        block.appendChild(title);

                        if (key.toLowerCase().includes("image") || key.toLowerCase().includes("thumbnail")) {
                            const fileInput = document.createElement("input");
                            fileInput.type = "file";
                            fileInput.name = fullKey;
                            fileInput.multiple = true;
                            fileInput.accept = "image/*";
                            fileInput.className = "form-control mt-2";
                            block.appendChild(fileInput);
                        } else {
                            const arrayGrid = document.createElement("div");
                            arrayGrid.classList.add("nested-grid");
                            value.forEach((item, i) => {
                                if (typeof item === "object") {
                                    const subBlock = document.createElement("div");
                                    subBlock.classList.add("section-subblock");
                                    generateFieldsFromObject(item, subBlock, `${fullKey}[${i}]`);
                                    arrayGrid.appendChild(subBlock);
                                } else {
                                    const input = createInputField(`${fullKey}[${i}]`, item, `Item ${i + 1}`);
                                    arrayGrid.appendChild(input);
                                }
                            });
                            block.appendChild(arrayGrid);
                        }

                        container.appendChild(block);
                    }

                    // ========== PRIMITIVE ==========
                    else {
                        if (key.toLowerCase().includes("image") && typeof value === "string" && /\.(jpg|png|jpeg|webp)$/i.test(value)) {
                            const block = document.createElement("div");
                            block.classList.add("section-block");

                            const label = document.createElement("h6");
                            label.textContent = key.toUpperCase();
                            block.appendChild(label);

                            const fileInput = document.createElement("input");
                            fileInput.type = "file";
                            fileInput.name = fullKey;
                            fileInput.accept = "image/*";
                            fileInput.className = "form-control mt-2";
                            block.appendChild(fileInput);

                            container.appendChild(block);
                        } else {
                            container.appendChild(createInputField(fullKey, value, key));
                        }
                    }
                });
            }

            function createInputField(name, value, labelText) {
                const wrapper = document.createElement("div");
                wrapper.classList.add("form-floating");

                const input = document.createElement("input");
                input.type = typeof value === "number" ? "number" : "text";
                input.name = name;
                input.id = name;
                input.value = value ?? "";
                input.className = "form-control";
                input.placeholder = labelText;

                const label = document.createElement("label");
                label.setAttribute("for", name);
                label.textContent = labelText.replace(/([A-Z])/g, " $1");

                wrapper.appendChild(input);
                wrapper.appendChild(label);
                return wrapper;
            }

            function addSubmitButton() {
                const btnDiv = document.createElement("div");
                btnDiv.classList.add("col-12");
                const submit = document.createElement("button");
                submit.type = "submit";
                submit.className = "btn btn-primary w-100";
                submit.textContent = "Save Product";
                btnDiv.appendChild(submit);
                form.appendChild(btnDiv);
            }

            await loadProductData();

            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                const formData = new FormData(form);

                // -------------------
                // Main Image
                // -------------------
                const mainFileInput = form.querySelector('input[name="image"]');
                const mainExisting = form.querySelector('input[name="image_existing"]')?.value;
                if (!mainFileInput.files.length && mainExisting) {
                    // preserve existing image
                    formData.delete("image");
                    formData.append("image_existing", mainExisting);
                }

                // -------------------
                // Thumbnails: gather all images in preview box
                // -------------------
                const thumbnailsArray = [];
                document.querySelectorAll(".thumbnail-preview img").forEach(img => {
                    thumbnailsArray.push(img.src); // keep all preview images
                });
                // Remove old FormData keys
                formData.delete("thumbnails");
                thumbnailsArray.forEach(t => formData.append("thumbnails[]", t));
                // -------------------
                // InTheBox images
                // -------------------
                const boxFiles = form.querySelectorAll('input[name*="inTheBoxImage"]');
                boxFiles.forEach((input, idx) => {
                    if (!input.files.length) {
                        const existing = form.querySelectorAll('input[name="inTheBoxImage_existing[]"]')[idx]?.value;
                        formData.append("inTheBoxImage_existing[]", existing || "");
                    }
                });

                try {
                    const res = await fetch(`/api/products/${productId}`, {
                        method: "PATCH",
                        body: formData, // send FormData directly
                        credentials: "include",
                    });
                    if (!res.ok) throw new Error("Failed to update product");
                    alert("✅ Product updated successfully!");
                    window.location.href = "products.html";
                } catch (err) {
                    console.error(err);
                    alert("Error updating product.");
                }
            });

            function assignNestedValue(obj, path, value) {
                const keys = path.replace(/\[(\d+)\]/g, ".$1").split(".");
                let current = obj;
                keys.forEach((key, i) => {
                    if (i === keys.length - 1) current[key] = value;
                    else {
                        if (!current[key]) current[key] = isNaN(keys[i + 1]) ? {} : [];
                        current = current[key];
                    }
                });
            }
        });
    </script>

</body>

</html>