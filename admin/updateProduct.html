<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DroneMart Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="assets/css/style.css" />

</head>

<body>


    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h4>DroneMart Admin</h4>
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="bi bi-arrow-left-circle"></i>
            </button>
        </div>
        <ul class="sidebar-menu">
            <li>
                <a href="dashboard.html" class="active">
                    <i class="fa-solid fa-gauge"></i>
                    <span class="menu-text">Dashboard</span>
                </a>
            </li>

            <li>
                <a href="users.html">
                    <i class="fa-solid fa-user-group"></i>
                    <span class="menu-text">Users</span>
                </a>
            </li>

            <li>
                <a href="leads.html">
                    <i class="fa-solid fa-address-card"></i>
                    <span class="menu-text">Leads</span>
                </a>
            </li>

            <li>
                <a href="repairs.html">
                    <i class="fa-solid fa-screwdriver-wrench"></i>
                    <span class="menu-text">Repair Requests</span>
                </a>
            </li>

            <li>
                <a href="customerInquiries.html">
                    <i class="fa-solid fa-users-gear"></i>
                    <span class="menu-text">Customer Inquiries</span>
                </a>
            </li>

            <li>
                <a href="products.html">
                    <i class="fa-solid fa-box-open"></i>
                    <span class="menu-text">Products</span>
                </a>
            </li>

            <li>
                <a href="accessories.html">
                    <i class="fa-solid fa-toolbox"></i>
                    <span class="menu-text">Accessories</span>
                </a>
            </li>

            <li>
                <a href="orders.html">
                    <i class="fa-solid fa-receipt"></i>
                    <span class="menu-text">Orders</span>
                </a>
            </li>

            <li>
                <a href="#">
                    <i class="fa-solid fa-chart-line"></i>
                    <span class="menu-text">Analytics</span>
                </a>
            </li>

            <li>
                <a href="#">
                    <i class="fa-solid fa-gear"></i>
                    <span class="menu-text">Settings</span>
                </a>
            </li>
        </ul>
    </div>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Topbar / Header -->
        <div class="topbar">
            <button class="hamburger" id="hamburger">
                <i class="bi bi-list"></i>
            </button>
            <h4 class="mb-0">Update Product</h4>
            <div class="profile p-3" id="profileToggle">
                <div class="d-flex align-items-center">
                    <img src="https://ui-avatars.com/api/?name=User&background=random" alt="Profile"
                        class="rounded-circle me-2" width="40" height="40">
                    <div class="d-none d-md-block">
                        <div class="fw-bold" id="adminName">User</div>
                        <small class="text-muted" id="userType">Guest</small>
                    </div>
                </div>
            </div>

            <!-- Profile Dropdown -->
            <div class="profile-dropdown" id="profileDropdown">
                <div class="dropdown-item">
                    <i class="bi bi-person"></i> Profile
                </div>
                <div class="dropdown-item">
                    <i class="bi bi-gear"></i> Settings
                </div>
                <div class="dropdown-item">
                    <i class="bi bi-bell"></i> Notifications
                </div>
                <hr>
                <div class="dropdown-item" id="logoutBtn">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </div>
            </div>
        </div>

        <div class="container my-4">
            <form id="productForm" enctype="multipart/form-data">

                <!-- Title -->
                <div class="form-floating mb-3">
                    <input type="text" name="title" id="title" placeholder="Product Title" class="form-control"
                        required>
                    <label>Title</label>
                </div>

                <!-- Brand & Category -->
                <div class="form-floating mb-3">
                    <input type="text" name="brand" placeholder="Brand" class="form-control" required>
                    <label>Brand</label>
                </div>
                <div class="form-floating mb-3">
                    <!-- <input type="text" name="category" placeholder="Category" class="form-control" required> -->
                    <select name="category" class="form-control" required>
                        <option value="">Select Category</option>
                        <option value="agriculture">Agriculture</option>
                        <option value="air-series">DJI Air</option>
                        <option value="mini-series">DJI Mini</option>
                        <option value="mavic-series">DJI Mavic</option>
                        <option value="flip-series">DJI Flip</option>
                        <option value="neo-series">DJI Neo</option>
                        <option value="avata-series">DJI Avata</option>
                        <option value="FPV">FPV</option>
                    </select>
                    <label>Category</label>
                </div>

                <!-- Price & Sale Price -->
                <div class="form-floating mb-3">
                    <input type="number" name="price" placeholder="Price" class="form-control" required>
                    <label>Price</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="number" name="salePrice" placeholder="Sale Price" class="form-control">
                    <label>Sale Price</label>
                </div>

                <!-- Stock & Badge -->
                <div class="form-floating mb-3">
                    <input type="number" name="stock" placeholder="Stock" class="form-control">
                    <label>Stock</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" name="badge" placeholder="Badge" class="form-control">
                    <label>Badge</label>
                </div>

                <!-- Descriptions -->
                <div class="form-floating mb-3">
                    <textarea name="description" placeholder="Description" class="form-control"
                        style="height:80px;"></textarea>
                    <label>Description</label>
                </div>
                <div class="form-floating mb-3">
                    <textarea name="shortDescription" placeholder="Short Description" class="form-control"
                        style="height:60px;"></textarea>
                    <label>Short Description</label>
                </div>

                <!-- Meta info -->
                <div class="form-floating mb-3">
                    <input type="text" name="metaTitle" placeholder="Meta Title" class="form-control">
                    <label>Meta Title</label>
                </div>
                <div class="form-floating mb-3">
                    <textarea name="metaDescription" placeholder="Meta Description" class="form-control"
                        style="height:60px;"></textarea>
                    <label>Meta Description</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" name="keywords" placeholder="Keywords" class="form-control">
                    <label>Keywords</label>
                </div>

                <!-- Main Image & Thumbnails -->
                <div class="form-floating mb-3">
                    <h6>Main Image</h6>
                    <input type="file" name="image" accept="image/*" class="form-control">
                    <div class="image-preview" id="mainPreview"></div>
                </div>
                <div class="form-floating mb-3">
                    <h6>Thumbnails</h6>
                    <input type="file" name="thumbnails" multiple accept="image/*" class="form-control">
                    <div class="image-preview" id="thumbPreview"></div>
                </div>

                <!-- In The Box -->
                <!-- <div class="section-block">
                    <h6>In The Box Items</h6>
                    <div id="inTheBoxContainer"></div>
                    <button type="button" onclick="addInTheBox()" class="btn btn-sm btn-success mt-2">+ Add
                        Item</button>
                </div> -->

                <!-- Specs -->
                <div class="section-block">
                    <h6>Specifications JSON</h6>
                    <textarea name="specs" class="form-control" rows="8"
                        placeholder='{"General":{"Brand":"DJI","Model":"Mini 3"}}'></textarea>

                </div>

                <!-- Features -->
                <div class="section-block">
                    <h6>Features</h6>
                    <input type="text" name="featuresText" class="form-control">

                </div>

                <!-- Featured Checkbox -->
                <div class="form-check mb-3">
                    <input type="checkbox" name="featured" class="form-check-input" id="featured">
                    <label class="form-check-label" for="featured">Featured</label>
                </div>

                <div class="mt-3">
                    <button type="submit" class="btn btn-primary w-25">Update Product</button>
                </div>
            </form>
        </div>



        <!-- Users Table -->

    </div>
    <script src="assets/js/common.js"></script>
    <script src="assets/js/main.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const productId = new URLSearchParams(window.location.search).get("id");
            if (!productId) return alert("No product ID provided");

            const form = document.getElementById("productForm");
            const inTheBoxContainer = document.getElementById('inTheBoxContainer');
            const mainPreview = document.getElementById('mainPreview');
            const thumbPreview = document.getElementById('thumbPreview');

            let currentThumbnails = [];
            let currentInTheBox = [];

            
            // --------------------------
            // Load Product Data
            // --------------------------
            async function loadProduct() {
                try {
                    const res = await fetch(`/api/products/${productId}`, { credentials: 'include' });
                    if (!res.ok) throw new Error("Failed to fetch product");
                    const product = await res.json();

                    // Populate basic fields
                    form.querySelector('[name="title"]').value = product.title || '';
                    form.querySelector('[name="brand"]').value = product.brand || '';
                    form.querySelector('[name="category"]').value = product.category || '';
                    form.querySelector('[name="price"]').value = product.price || '';
                    form.querySelector('[name="salePrice"]').value = product.salePrice || '';
                    form.querySelector('[name="stock"]').value = product.stock || '';
                    form.querySelector('[name="badge"]').value = product.badge || '';
                    form.querySelector('[name="description"]').value = product.description || '';
                    form.querySelector('[name="shortDescription"]').value = product.shortDescription || '';
                    form.querySelector('[name="metaTitle"]').value = product.metaTitle || '';
                    form.querySelector('[name="metaDescription"]').value = product.metaDescription || '';
                    form.querySelector('[name="keywords"]').value = Array.isArray(product.keywords) ? product.keywords.join(', ') : '';
                    form.querySelector('[name="featuresText"]').value = Array.isArray(product.features) ? product.features.join(', ') : '';
                    form.querySelector('[name="featured"]').checked = !!product.featured;
                    form.querySelector('[name="specs"]').value = product.specs ? JSON.stringify(product.specs, null, 2) : '';

                    // Main Image
                    if (product.image) {
                        mainPreview.innerHTML = `<img src="${product.image}" style="max-width:150px; border-radius:6px;">`;
                        const hidden = document.createElement('input');
                        hidden.type = 'hidden';
                        hidden.name = 'image_existing';
                        hidden.value = product.image;
                        form.appendChild(hidden);
                    }

                    // Thumbnails
                    if (Array.isArray(product.thumbnails)) {
                        currentThumbnails = [...product.thumbnails];
                        renderThumbnails();
                    }

                    function renderThumbnails() {
                        thumbPreview.innerHTML = '';
                        currentThumbnails.forEach((thumb, i) => {
                            const wrapper = document.createElement('div');
                            wrapper.style.position = 'relative';
                            wrapper.style.width = '100px';
                            wrapper.style.height = '100px';
                            wrapper.style.marginRight = '6px';
                            wrapper.style.display = 'inline-block';

                            const img = document.createElement('img');
                            img.src = typeof thumb === 'string' ? thumb : URL.createObjectURL(thumb);
                            img.style.width = '100%';
                            img.style.height = '100%';
                            img.style.objectFit = 'cover';
                            img.style.borderRadius = '6px';
                            img.style.border = '1px solid #ccc';
                            wrapper.appendChild(img);

                            const delBtn = document.createElement('button');
                            delBtn.type = 'button';
                            delBtn.textContent = '×';
                            delBtn.style.position = 'absolute';
                            delBtn.style.top = '2px';
                            delBtn.style.right = '2px';
                            delBtn.style.width = '20px';
                            delBtn.style.height = '20px';
                            delBtn.style.background = 'rgba(0,0,0,0.6)';
                            delBtn.style.color = '#fff';
                            delBtn.style.border = 'none';
                            delBtn.style.borderRadius = '50%';
                            delBtn.style.cursor = 'pointer';
                            delBtn.addEventListener('click', () => {
                                currentThumbnails.splice(i, 1);
                                renderThumbnails();
                            });
                            wrapper.appendChild(delBtn);

                            thumbPreview.appendChild(wrapper);
                        });
                    }

                    form.querySelector('input[name="thumbnails"]').addEventListener('change', e => {
                        const newFiles = Array.from(e.target.files);
                        if (newFiles.length > 0) {
                            currentThumbnails.push(...newFiles);
                            renderThumbnails();
                        }
                    });


                } catch (err) {
                    console.error(err);
                    alert("Error loading product data");
                }
            }

            await loadProduct();

            // --------------------------
            // Form Submit
            // --------------------------
            form.addEventListener('submit', async e => {
                e.preventDefault();
                const formData = new FormData(form);

                // Slug
                const title = form.querySelector('[name="title"]').value;
                formData.set('slug', title.toLowerCase().trim().replace(/\s+/g, '-').replace(/[^a-z0-9\-]/g, ''));

                // Specs
                formData.set('specs', form.querySelector('[name="specs"]').value);

                // Thumbnails
                formData.delete('thumbnails');
                currentThumbnails.forEach(t => {
                    if (typeof t === 'string') formData.append('thumbnails_existing[]', t);
                    else formData.append('thumbnails', t);
                });

                // Main Image
                const mainFileInput = form.querySelector('input[name="image"]');
                const mainExisting = form.querySelector('input[name="image_existing"]')?.value;
                if (!mainFileInput.files.length && mainExisting) {
                    formData.delete('image');
                    formData.set('image_existing', mainExisting);
                }

                // Features
                const featuresText = form.querySelector('[name="featuresText"]').value;
                formData.set('features', JSON.stringify(featuresText.split(',').map(f => f.trim()).filter(f => f)));

                // Featured
                formData.set('featured', form.querySelector('[name="featured"]').checked);

                try {
                    const res = await fetch(`/api/products/${productId}`, {
                        method: 'PATCH',
                        body: formData,
                        credentials: 'include'
                    });
                    if (res.ok) alert('✅ Product updated successfully!');
                    else {
                        const errData = await res.json();
                        console.error(errData);
                        alert('❌ Error updating product: ' + (errData.message || 'Unknown error'));
                    }
                } catch (err) {
                    console.error(err);
                    alert('❌ Error updating product');
                }
            });
        });
    </script>

</body>

</html>