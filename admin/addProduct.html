<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DroneMart Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="assets/css/style.css" />

</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h4>DroneMart Admin</h4>
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="bi bi-arrow-left-circle"></i>
            </button>
        </div>
        <ul class="sidebar-menu">
            <li>
                <a href="dashboard.html" class="active">
                    <i class="fa-solid fa-gauge"></i>
                    <span class="menu-text">Dashboard</span>
                </a>
            </li>

            <li>
                <a href="users.html">
                    <i class="fa-solid fa-user-group"></i>
                    <span class="menu-text">Users</span>
                </a>
            </li>

            <li>
                <a href="leads.html">
                    <i class="fa-solid fa-address-card"></i>
                    <span class="menu-text">Leads</span>
                </a>
            </li>

            <li>
                <a href="repairs.html">
                    <i class="fa-solid fa-screwdriver-wrench"></i>
                    <span class="menu-text">Repair Requests</span>
                </a>
            </li>

            <li>
                <a href="products.html">
                    <i class="fa-solid fa-box-open"></i>
                    <span class="menu-text">Products</span>
                </a>
            </li>

            <li>
                <a href="accessories.html">
                    <i class="fa-solid fa-puzzle-piece"></i>
                    <span class="menu-text">Accessories</span>
                </a>
            </li>

            <li>
                <a href="orders.html">
                    <i class="fa-solid fa-receipt"></i>
                    <span class="menu-text">Orders</span>
                </a>
            </li>

            <li>
                <a href="#">
                    <i class="fa-solid fa-chart-line"></i>
                    <span class="menu-text">Analytics</span>
                </a>
            </li>

            <li>
                <a href="#">
                    <i class="fa-solid fa-gear"></i>
                    <span class="menu-text">Settings</span>
                </a>
            </li>
        </ul>
    </div>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Topbar / Header -->
        <div class="topbar">
            <button class="hamburger" id="hamburger">
                <i class="bi bi-list"></i>
            </button>
            <h4 class="mb-0">Add Product</h4>
            <div class="profile p-3" id="profileToggle">
                <div class="d-flex align-items-center">
                    <img src="https://ui-avatars.com/api/?name=User&background=random" alt="Profile"
                        class="rounded-circle me-2" width="40" height="40">
                    <div class="d-none d-md-block">
                        <div class="fw-bold" id="adminName">User</div>
                        <small class="text-muted" id="userType">Guest</small>
                    </div>
                </div>
            </div>

            <!-- Profile Dropdown -->
            <div class="profile-dropdown" id="profileDropdown">
                <div class="dropdown-item">
                    <i class="bi bi-person"></i> Profile
                </div>
                <div class="dropdown-item">
                    <i class="bi bi-gear"></i> Settings
                </div>
                <div class="dropdown-item">
                    <i class="bi bi-bell"></i> Notifications
                </div>
                <hr>
                <div class="dropdown-item" id="logoutBtn">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </div>
            </div>
        </div>

        <div class="container my-4">
            <form id="productForm" enctype="multipart/form-data">

                <!-- Title -->
                <div class="form-floating mb-3">
                    <input type="text" name="title" id="title" placeholder="Product Title" class="form-control"
                        required>
                    <label>Title</label>
                </div>

                <!-- Brand & Category -->
                <div class="form-floating mb-3">
                    <input type="text" name="brand" placeholder="Brand" class="form-control" required>
                    <label>Brand</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" name="category" placeholder="Category" class="form-control" required>
                    <label>Category</label>
                </div>

                <!-- Price & Sale Price -->
                <div class="form-floating mb-3">
                    <input type="number" name="price" placeholder="Price" class="form-control" required>
                    <label>Price</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="number" name="salePrice" placeholder="Sale Price" class="form-control">
                    <label>Sale Price</label>
                </div>

                <!-- Stock & Badge -->
                <div class="form-floating mb-3">
                    <input type="number" name="stock" placeholder="Stock" class="form-control">
                    <label>Stock</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" name="badge" placeholder="Badge" class="form-control">
                    <label>Badge</label>
                </div>

                <!-- Descriptions -->
                <div class="form-floating mb-3">
                    <textarea name="description" placeholder="Description" class="form-control"
                        style="height:80px;"></textarea>
                    <label>Description</label>
                </div>
                <div class="form-floating mb-3">
                    <textarea name="shortDescription" placeholder="Short Description" class="form-control"
                        style="height:60px;"></textarea>
                    <label>Short Description</label>
                </div>

                <!-- Meta info -->
                <div class="form-floating mb-3">
                    <input type="text" name="metaTitle" placeholder="Meta Title" class="form-control">
                    <label>Meta Title</label>
                </div>
                <div class="form-floating mb-3">
                    <textarea name="metaDescription" placeholder="Meta Description" class="form-control"
                        style="height:60px;"></textarea>
                    <label>Meta Description</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" name="keywords" placeholder="Keywords" class="form-control">
                    <label>Keywords</label>
                </div>

                <!-- Main Image & Thumbnails -->
                <div class="form-floating mb-3">
                    <h6>Main Image</h6>
                    <input type="file" name="image" accept="image/*" class="form-control">
                    <div class="image-preview" id="mainPreview"></div>
                </div>
                <div class="form-floating mb-3">
                    <h6>Thumbnails</h6>
                    <input type="file" name="thumbnails" multiple accept="image/*" class="form-control">
                    <div class="image-preview" id="thumbPreview"></div>
                </div>

                <!-- In The Box -->
                <div class="section-block">
                    <h6>In The Box Items</h6>
                    <div id="inTheBoxContainer"></div>
                    <button type="button" onclick="addInTheBox()" class="btn btn-sm btn-success mt-2">+ Add
                        Item</button>
                </div>

                <!-- Specs -->
                <div class="section-block">
                    <h6>Specs</h6>
                    <div id="specCategoriesContainer"></div>
                    <button type="button" onclick="addSpecCategory()" class="btn btn-sm btn-success mt-2">+ Add
                        Category</button>
                </div>

                <!-- Features -->
                <div class="section-block">
                    <h6>Features</h6>
                    <div id="featuresContainer"></div>
                    <button type="button" onclick="addFeature()" class="btn btn-sm btn-success mt-2">+ Add
                        Feature</button>
                </div>

                <!-- Featured Checkbox -->
                <div class="form-check mb-3">
                    <input type="checkbox" name="featured" class="form-check-input" id="featured">
                    <label class="form-check-label" for="featured">Featured</label>
                </div>

                <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-primary w-100">Add Product</button>
                </div>
            </form>
        </div>

        <!-- Users Table -->

    </div>
    <script src="assets/js/common.js"></script>
    <script src="assets/js/main.js"></script>


    <script>
        // ===== Utility =====
        function generateSlug(title) {
            return title.toLowerCase().trim().replace(/\s+/g, '-').replace(/[^a-z0-9\-]/g, '');
        }

        // ===== Specs =====
        const specCategoriesContainer = document.getElementById('specCategoriesContainer');

        function addSpecCategory(name = '') {
            const div = document.createElement('div');
            div.classList.add('spec-category', 'mb-3', 'border', 'p-2', 'rounded');
            div.innerHTML = `
            <div class="d-flex gap-2 mb-2">
                <input type="text" placeholder="Category Name" class="form-control spec-category-name" value="${name}">
                <button type="button" class="btn btn-sm btn-success">+ Add Spec</button>
                <button type="button" class="btn btn-sm btn-danger">Remove Category</button>
            </div>
            <div class="specsContainer ps-3"></div>
        `;
            div.querySelector('.btn-success').addEventListener('click', () => addSpec(div.querySelector('.specsContainer')));
            div.querySelector('.btn-danger').addEventListener('click', () => div.remove());
            specCategoriesContainer.appendChild(div);
        }

        function addSpec(container, key = '', value = '') {
            const div = document.createElement('div');
            div.classList.add('spec-item', 'mb-2');
            div.innerHTML = `
            <div class="d-flex gap-2 mb-1">
                <input type="text" placeholder="Spec Key" class="spec-key form-control" value="${key}">
                <input type="text" placeholder="Spec Value (optional)" class="spec-value form-control" value="${value}">
                <button type="button" class="btn btn-sm btn-success">+ Nested</button>
                <button type="button" class="btn btn-sm btn-danger">Remove</button>
            </div>
            <div class="nested-specs ps-3"></div>
        `;
            div.querySelector('.btn-success').addEventListener('click', () => addSpec(div.querySelector('.nested-specs')));
            div.querySelector('.btn-danger').addEventListener('click', () => div.remove());
            container.appendChild(div);
        }

        function buildSpecs(container) {
            const obj = {};
            Array.from(container.children).forEach(child => {
                if (child.classList.contains('spec-item')) {
                    const key = child.querySelector('.spec-key').value.trim();
                    const value = child.querySelector('.spec-value').value.trim();
                    const nested = child.querySelector('.nested-specs');
                    obj[key] = nested && nested.children.length ? buildSpecs(nested) : value;
                }
            });
            return obj;
        }

        function buildSpecsJSON() {
            const specs = {};
            Array.from(specCategoriesContainer.children).forEach(categoryDiv => {
                const catName = categoryDiv.querySelector('.spec-category-name').value.trim();
                if (!catName) return;
                const container = categoryDiv.querySelector('.specsContainer');
                specs[catName] = buildSpecs(container);
            });
            return specs;
        }

        // ===== In The Box =====
        const inTheBoxContainer = document.getElementById('inTheBoxContainer');
        function addInTheBox(title = '', qty = 1) {
            const div = document.createElement('div');
            div.classList.add('box-item', 'd-flex', 'gap-3' , 'mb-2');
            div.innerHTML = `
            <input type="text" name="inTheBoxTitle[]" placeholder="Item Title" class="form-control mb-1" value="${title}" required>
            <input type="number" name="inTheBoxQty[]" placeholder="Quantity" value="${qty}" class="form-control mb-1">
            <input type="file" name="inTheBoxImage[]" accept="image/*" class="form-control mb-1">
            <button type="button" class="btn btn-sm btn-danger mb-2">Remove</button>
        `;
            div.querySelector('button').addEventListener('click', () => div.remove());
            inTheBoxContainer.appendChild(div);
        }

        // ===== Features =====
        const featuresContainer = document.getElementById('featuresContainer');
        function addFeature(text = '') {
            const div = document.createElement('div');
            div.classList.add('feature-item', 'mb-2', 'd-flex', 'gap-2');
            div.innerHTML = `
            <input type="text" name="features[]" placeholder="Feature" class="form-control" value="${text}">
            <button type="button" class="btn btn-sm btn-danger">Remove</button>
        `;
            div.querySelector('button').addEventListener('click', () => div.remove());
            featuresContainer.appendChild(div);
        }

        // ===== Form Submit =====
        document.getElementById('productForm').addEventListener('submit', async e => {
            e.preventDefault();
            const form = document.getElementById('productForm');
            const formData = new FormData(form);

            // slug
            const title = form.querySelector('[name="title"]').value;
            formData.append('slug', generateSlug(title));

            // specs
            formData.append('specs', JSON.stringify(buildSpecsJSON()));

            // InTheBox
            const boxItems = [];
            Array.from(inTheBoxContainer.children).forEach(div => {
                const title = div.querySelector('input[name="inTheBoxTitle[]"]').value;
                const qty = div.querySelector('input[name="inTheBoxQty[]"]').value;
                boxItems.push({ title, quantity: Number(qty) });
            });
            formData.append('inTheBox', JSON.stringify(boxItems));

            // Features
            const features = Array.from(featuresContainer.querySelectorAll('input[name="features[]"]')).map(f => f.value);
            formData.append('features', JSON.stringify(features));

            // Featured checkbox
            formData.set('featured', form.querySelector('[name="featured"]').checked);

            try {
                const res = await fetch('/api/products', { method: 'POST', body: formData, credentials: 'include' });
                if (res.ok) alert('✅ Product added!');
                else alert('❌ Error adding product');
            } catch (err) {
                console.error(err);
                alert('❌ Error adding product');
            }
        });
    </script>

</body>

</html>